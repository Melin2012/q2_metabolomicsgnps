# QIIME 2 Metabolomics GNPS plugin

This is a QIIME 2 plugin to analyze metabolomics data that utilizes GNPS.

## Background

Mass spectrometry detects molecules via charged surrogates called ions (i.e. mass-to-charge, m/z). MS data contains MS1 spectra (i.e. spectrum of all ions; m/z and their respective abundance) and MS2 spectra (i.e. spectrum of structural fragments of an ion). MS2. spectra are generated by imparting excess internal energy into ions which causes them to dissociate into smaller mass fragments. Collision induced dissociation (CID) or higher-energy collision induced dissociation (HCD) are common methods applied to non-volatile ionized molecules to impart energy via collisions with gas molecules. One can collect both MS1 and MS2 spectra in a single experiment using data dependent acquisition (DDA), a common approach used in untargeted metabolomics. The data contains a series of MS1 spectra from which the n most abundant m/z values are selected and fragmented serially. This cycle continues throughout the analysis of a sample. Often, liquid chromatography (or chemical separation techniques) are combined with mass spectrometry to i) simplify sample complexity, ii) provide orthogonal information (e.g. retention time), and iii) increase coverage of the fragmentation approach to fragment more unique ions (e.g. isomers separated by chromatography can all be fragmented individually). Samples can be compared qualitatively and/or quantitatively using either MS1 or MS2 data or a combination of the two.

## MS2 Spectral Counts

If one were to collect data using DDA or similar method, multiple MS2 spectra from the sample ion (aka molecule) can be present in the data. One of the initial data analysis processes performed in GNPS (via MScluster) is to collapse identical spectra into a single molecular feature. The number of fragmentation spectra measured for each molecular feature (unique  ion) per sample, i.e. spectral counts, can be used as a semiquantitative estimate: i.e. the higher the spectral count, the more abundant the molecular feature will be as it triggered multiple fragmentation events.

## MS1 Peak Areas

Fundamentally, spectral abundance observed at a given time in a mass spectrum is related to concentration (imperfectly); however, integration of spectral abundance over time better represents the concentration of a particular compound  in the sample. Extraction ion chromatograms (XIC) are generated from all observed m/z in the MS1 of a sample, and the area under the curve (i.e. peak area) are determined via integration. Advantage of comparing samples using the MS1 peak area is that the quantitative information can be more accurate as well as more sensitively, particularly for those compounds of low abundance, as not all ions will be selected in the top n most abundant peaks and thus not trigger a MS2 fragmentation event.

## Installation

Install Qiime2 and activate environment by following the steps described [here](https://docs.qiime2.org/2018.6/install/native/).

Test if the Qiime2 installation was successful by typing the following command:

```
qiime
```

If Qiime2 was successfully installed, options will appear.

To install the q2_metabolomicsgnps plugin, you have two options

```
conda install -c mwang87 q2-metabolomicsgnps 
```

or 

```
git clone https://github.com/mwang87/q2_metabolomicsgnps
cd q2_metabolomicsgnps
pip install -e .
```

Test if the plugin was installed correctly by repeating the following command:

```
qiime
```

If successful, the metabolomics-gnps plugin is now listed in the options.

### Plugin Commands Listing

List all commands

`qiime metabolomicsgnps` 

MS2 GNPS Clustering Command. This function will take as input a set of mass spectrometry files (mzXML or mzML) and a manifest file to produce a biom qza file.

`qiime metabolomicsgnps gnps-clustering` 

MS2 GNPS Clustering Command. This function will take as input an existing GNPS Molecular Networking task and a manifest file to produce a biom qza file.

`qiime metabolomicsgnps gnps-clustering-taskimport` 

MZmine2 Feature Import Command. This function will take as input a feature quantification file from MZmine2 and a manifest file and produce a biom qza file.

`qiime metabolomicsgnps mzmine2-clustering`

### Example of job GNPS-clustering job:

`qiime metabolomicsgnps gnps-clustering --p-manifest data/manifest.tsv --p-username <username> --p-password <password> --o-feature-table outputfolder`

### Example of job GNPS-clustering-taskimport job:

`qiime metabolomicsgnps gnps-clustering --p-manifest data/manifest.tsv --p-taskid cde9c128ec0c48a58e650279f1735dbc --o-feature-table outputfolder`

### Example of MZmine2-CLUSTERING job:

`qiime metabolomicsgnps mzmine2-clustering --p-manifest tests/data/mzminemanifest.csv --p-quantificationtable tests/data/mzminefeatures.csv --o-feature-table feature`

## Input Data Description/Download

### Cross-Sectional Data

### Longitudinal Data

### MZmine2 Export

MZmine2 is used to find features in the data and calculate the area under the curve. A detailed tutorial for feature finding with MZmine2 can be found [here] (https://ccms-ucsd.github.io/GNPSDocumentation/featurebasedmolecularnetworking/).

Upon finding all features according to the tutorial above, perform the following steps to export the features and their respective quantifications to be compatible with this Qiime2 plugin.

Select Export->CSV File

1. Specify .csv file name and location
2. Check “Export row ID”, “Export row m/z” and “Export row retention time”
3. Check “Peak area”

![img](img/mzmine_export.png)

4. Hit OK
5. The generated .csv file can now be used directly for further processing in Qiime2 in the Feature Based Quantification Analysis

### Manifest File Format

The manifest file specifies the location of the files that will be processed by the metabolomicsgnps plugin. It is a .CSV formatted table that contains two columns (See Figure X below). The first column indicates the ‘sample-id’ for each file, while the second column indicates its corresponding relative file path (relative to where qiime commands are called). The gnps-clustering and the mzmine2-clustering tools are using both the same manifest file.

Figure X. View of the manifest file (.CSV format). The first column indicates the ‘sample-id’ for each file, while the second column indicates its corresponding relative file path. The example file can be [downloaded here](https://github.com/mwang87/q2_metabolomicsgnps/raw/master/q2_metabolomicsgnps/tests/data/manifest.tsv).

![img](img/manifest_file.png)

## Spectrum Count Qualitative Analysis

### Food Cross Sectional Study

### Longitudinal Study

## Feature Based Quantification Analysis (mzmine2)

### Food Cross Sectional Study

## Specify the path to manifest file and mzmine2 feature table. 

This step will create .qza file for further analysis in qiime2
	
`qiime metabolomicsgnps mzmine2-clustering \
--p-manifest manifest_cat.csv  \
--p-quantificationtable Feature_Table_Cat.csv \ 
--o-feature-table feature_mzmine2_cat.qza`

# (Optional) Create a summary table. 

This step creates qzv file for further visualization in qiime2 view (https://view.qiime2.org/)

`qiime feature-table summarize \
--i-table feature_mzmine2_cat.qza \
--o-visualization table_cat.qzv \
--m-sample-metadata-file metadata_cat.txt`

## Compute the Shannon diversity index for all samples

To compute the Shannon diversity index for all samples contained within your ms1 feature table, use the qiime diversity alpha function: 

`qiime diversity alpha \
--i-table feature_mzmine2_cat.qza \
--p-metric shannon \
--o-alpha-diversity shannon.qza`

The output file ‘shannon.qza’ contains the per sample Shannon diversity index. You can inspect a .qza file by using a Text Editor (e.g. TextWrangler).

## Compute pairwise canberra distances and visualization in interactive PCoA space

To compute all pairwise canberra distances, you can use the qiime diversity beta function:

`qiime diversity beta \
--i-table feature_mzmine2_cat.qza \
--p-metric canberra \
--output-dir canberra_qiime2`

The output consists of a distance matrix, comprising the canberra distances of all pairs of samples provided in the mass spectral feature table. You can specify a distance metric of your choice using the --p-metric option (e.g. braycurtis, jaccard, mahalanobis, euclidean, etc.)

The resulting distance matrix can be used for PCoA analysis. To create PCos from the above created canberra matrix of pairwise distances type:

`qiime diversity pcoa \
--i-distance-matrix canberra_qiime2/distance_matrix.qza \
--output-dir pcoa_canberra_qiime2`

To create an interactive ordination plot of the above created PCoA with integrated sample metadata use the qiime emperor plot function. Make sure that the ‘sample-id’s provided in the metadata file correspond to the sample-ids in the canberra distance_matrix.qza file:

`qiime emperor plot \
--i-pcoa pcoa_canberra_qiime2/pcoa.qza \
--m-metadata-file metadata_cat.txt \
--output-dir emperor_qiime2`


To visualize the PCoA type:

`qiime tools view emperor_qiime2/visualization.qzv`

Or drag and drop emperor_qiime2/visualization.qzv to https://view.qiime2.org/

PLOT here

Plot X. Principal Coordinates Analysis (PCoA) was performed on metabolomics data with mzmine2(ms1) based feature table. Food sample from animal sources (red) and plant sources (blue) were distinguished from one another visually in PCoA space supporting that molecular differences between animal and plant sourced food are differentiating. 

### Longitudinal Study
